#!/bin/bash

# pnpm λ²„μ „ μ²΄ν¬ λ° μ„¤μ •
check_pnpm_version() {
    local required_pnpm_version=$(node -p "require('./package.json').packageManager.replace(/^pnpm@|[^0-9.]/g, '')")
    local current_pnpm_version=$(pnpm --version)
    
    if [ "$current_pnpm_version" != "$required_pnpm_version" ]; then
        echo "β pnpm λ²„μ „ λ¶μΌμΉ: ν„μ¬ $current_pnpm_version, ν•„μ” λ²„μ „ $required_pnpm_version"
        echo "π’΅ λ‹¤μ λ…λ Ήμ–΄λ΅ ν•„μ”ν• λ²„μ „μ„ μ„¤μΉν•μ„Έμ”: npm install -g pnpm@$required_pnpm_version"
        return 1
    fi
    return 0
}

# λ³€κ²½λ νμΌ λ©λ΅ κ°€μ Έμ¤κΈ°
changed_files="$(git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD 2>/dev/null || true)"

check_run() {
    if echo "$changed_files" | grep -q "$1"; then
        echo "$INSTALL_MESSAGE"
        
        # pnpm-lock.yamlμ΄ λ³€κ²½λ κ²½μ°μ—λ§ pnpm λ²„μ „ μ²΄ν¬
        if echo "$changed_files" | grep -q "$LOCK_FILE"; then
            echo "π” pnpm λ²„μ „μ„ ν™•μΈν•©λ‹λ‹¤..."
            if ! check_pnpm_version; then
                echo "β pnpm λ²„μ „ μ²΄ν¬ μ‹¤ν¨"
                return 1
            fi
        fi
        
        output=$(eval "$2" 2>&1)
        if [ $? -eq 0 ]; then
            echo "$RESULT_MESSAGE"
            return 0
        else
            echo "β ν¨ν‚¤μ§€ μ„¤μΉ μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤:"
            echo "-------------------"
            echo "$output"
            echo "-------------------"
            return 1
        fi
    fi
}

LOCK_FILE="pnpm-lock.yaml"
INSTALL_MESSAGE="π” μ›κ²© μ €μ¥μ†μ pnpm-lock.yamlμ΄ λ³€κ²½λμ—μµλ‹λ‹¤. pnpm installμ„ μ‹¤ν–‰ν•©λ‹λ‹¤."
INSTALL_COMMAND="pnpm install --frozen-lockfile"
RESULT_MESSAGE="β… ν¨ν‚¤μ§€ μμ΅΄μ„± μ—…λ°μ΄νΈ μ™„λ£!"

check_run "$LOCK_FILE" "$INSTALL_COMMAND"